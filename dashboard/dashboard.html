<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Logística</title>

    <link rel="stylesheet" href="dashboard.css">

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>

<div class="container">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Dashboard de Colaboradores</h2>
        <a href="../lista/lista.html" class="btn btn-primary">← Voltar para a Lista</a>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">

        <div class="col-md-4">
            <label for="filtroSetor">Filtrar por Setor</label>
            <select id="filtroSetor" class="form-control">
                <option value="">Todos</option>
            </select>
        </div>

        <div class="col-md-4">
            <label for="filtroArmazem">Filtrar por Armazém</label>
            <select id="filtroArmazem" class="form-control">
                <option value="">Todos</option>
            </select>
        </div>

        <div class="col-md-4">
            <label for="filtroStatus">Filtrar por Status</label>
            <select id="filtroStatus" class="form-control">
                <option value="">Todos</option>
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
            </select>
        </div>

    </div>

    <!-- KPIs -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="kpi-box">
                <div class="kpi-value" id="kpiTotal">0</div>
                <div class="kpi-title">Total de Colaboradores</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="kpi-box">
                <div class="kpi-value" id="kpiAtivos">0</div>
                <div class="kpi-title">Ativos</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="kpi-box">
                <div class="kpi-value" id="kpiInativos">0</div>
                <div class="kpi-title">Inativos</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="kpi-box">
                <div class="kpi-value" id="kpiDiaristas">0</div>
                <div class="kpi-title">Diaristas</div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card-box">
                <h5 class="text-center">Colaboradores por Setor</h5>
                <canvas id="graficoSetor"></canvas>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card-box">
                <h5 class="text-center">Colaboradores por Armazém</h5>
                <canvas id="graficoArmazem"></canvas>
            </div>
        </div>
    </div>

</div>

<script>

// ----------------------------
// VARIÁVEIS GLOBAIS
// ----------------------------
let colaboradores = [];
let colaboradoresFiltrados = [];

let graficoSetorInstance = null;
let graficoArmazemInstance = null;

// ----------------------------
// 1 - Carregar dados do backend
// ----------------------------
async function carregarColaboradores() {
    try {
        const res = await fetch("http://localhost:3000/colaboradores");
        colaboradores = await res.json();
        colaboradoresFiltrados = [...colaboradores];

        preencherFiltros();
        montarKPIs();
        montarGraficos();

    } catch (err) {
        console.error("Erro ao carregar colaboradores:", err);
        alert("Erro ao carregar os dados do servidor!");
    }
}

carregarColaboradores();

// ----------------------------
// 2 - Preencher filtros dinamicamente
// ----------------------------
function preencherFiltros() {
    const setores = [...new Set(colaboradores.map(c => c.setor))];
    const armazens = [...new Set(colaboradores.map(c => c.armazem))];

    setores.forEach(setor => {
        const op = document.createElement("option");
        op.value = setor;
        op.textContent = setor;
        document.getElementById("filtroSetor").appendChild(op);
    });

    armazens.forEach(arm => {
        const op = document.createElement("option");
        op.value = arm;
        op.textContent = arm;
        document.getElementById("filtroArmazem").appendChild(op);
    });
}

// ----------------------------
// 3 - KPIs
// ----------------------------
function montarKPIs() {
    const lista = colaboradoresFiltrados;

    document.getElementById("kpiTotal").innerText = lista.length;

    const ativos = lista.filter(c => (c.status || "").toLowerCase() === "ativo");
    const inativos = lista.filter(c => (c.status || "").toLowerCase() !== "ativo");
    const diaristas = lista.filter(c => (c.contratacao || "").toLowerCase() === "diarista");

    document.getElementById("kpiAtivos").innerText = ativos.length;
    document.getElementById("kpiInativos").innerText = inativos.length;
    document.getElementById("kpiDiaristas").innerText = diaristas.length;
}

// ----------------------------
// 4 - Gráficos dinâmicos
// ----------------------------
function montarGraficos() {

    const lista = colaboradoresFiltrados;

    // ----- SETOR -----
    const setores = {};
    lista.forEach(c => {
        if (c.setor) setores[c.setor] = (setores[c.setor] || 0) + 1;
    });

    if (graficoSetorInstance) graficoSetorInstance.destroy();

    graficoSetorInstance = new Chart(document.getElementById("graficoSetor"), {
        type: "bar",
        data: {
            labels: Object.keys(setores),
            datasets: [{
                label: "Qtd",
                data: Object.values(setores),
                backgroundColor: "rgba(54,162,235,0.7)"
            }]
        },
        options: { responsive: true }
    });

    // ----- ARMAZÉM -----
    const armazens = {};
    lista.forEach(c => {
        if (c.armazem) armazens[c.armazem] = (armazens[c.armazem] || 0) + 1;
    });

    if (graficoArmazemInstance) graficoArmazemInstance.destroy();

    graficoArmazemInstance = new Chart(document.getElementById("graficoArmazem"), {
        type: "pie",
        data: {
            labels: Object.keys(armazens),
            datasets: [{
                label: "Qtd",
                data: Object.values(armazens),
                backgroundColor: ["#36A2EB", "#FF6384", "#FFCE56", "#4BC0C0"]
            }]
        },
        options: { responsive: true }
    });
}

// ----------------------------
// 5 - Aplicar filtros
// ----------------------------
function aplicarFiltros() {

    const setor = document.getElementById("filtroSetor").value;
    const armazem = document.getElementById("filtroArmazem").value;
    const status = document.getElementById("filtroStatus").value;

    colaboradoresFiltrados = colaboradores.filter(c => {

        const okSetor = setor ? c.setor === setor : true;
        const okArmazem = armazem ? c.armazem === armazem : true;
        const okStatus = status ? c.status?.toLowerCase() === status : true;

        return okSetor && okArmazem && okStatus;
    });

    montarKPIs();
    montarGraficos();
}

// Eventos dos filtros
document.getElementById("filtroSetor").addEventListener("change", aplicarFiltros);
document.getElementById("filtroArmazem").addEventListener("change", aplicarFiltros);
document.getElementById("filtroStatus").addEventListener("change", aplicarFiltros);

</script>

</body>
</html>
