<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cadastro - Log√≠stica</title>
    <link rel="stylesheet" href="cadastro.css">
</head>

<body>
<div class="container">
    <div class="header">
        <h1>Cadastro de Colaborador</h1>
        <p>Sistema interno ‚Ä¢ Log√≠stica</p>
    </div>

    <form class="form" id="form-colaborador">
        <h2>Dados Pessoais</h2>
        <div class="grid">
            <div class="input-group">
                <label>Nome Completo</label>
                <input id="nome" type="text" placeholder="Ex: Jo√£o da Silva" required>
            </div>

            <div class="input-group">
                <label>Email</label>
                <input id="email" type="email" placeholder="Ex: joao.silva@empresa.com" required>
            </div>

            <div class="input-group">
                <label>CPF</label>
                <input id="cpf" type="text" maxlength="14" placeholder="Ex: 123.456.789-00"
                       oninput="mascaraCPF(this)" required>
            </div>

            <div class="input-group">
                <label>Telefone</label>
                <input id="telefone" type="text" maxlength="15" placeholder="Ex: (11) 91234-5678"
                       oninput="mascaraTelefone(this)" required>
            </div>
        </div>

        <h2>Endere√ßo</h2>
        <div class="grid">
            <div class="input-group">
                <label>CEP</label>
                <input id="cep" type="text" maxlength="9" placeholder="Ex: 29100-000"
                       oninput="mascaraCEP(this); buscarCEP(this.value)" required>
            </div>

            <div class="input-group">
                <label>Endere√ßo</label>
                <input id="endereco" type="text" placeholder="Ex: Rua das Flores" required>
            </div>

            <div class="input-group">
                <label>N√∫mero</label>
                <input id="numero" type="text" placeholder="Ex: 120">
            </div>

            <div class="input-group">
                <label>Cidade</label>
                <input id="cidade" type="text" placeholder="Ex: Serra" required>
            </div>

            <div class="input-group">
                <label>Estado</label>
                <input id="estado" type="text" maxlength="2" placeholder="Ex: ES" required>
            </div>
        </div>

        <h2>Dados da Empresa</h2>
        <div class="grid">
            <div class="input-group">
                <label>Armaz√©m</label>
                <select id="armazem" required>
                    <option value="">Selecione...</option>
                    <option value="Taquara">Taquara</option>
                    <option value="Porto Canoa">Porto Canoa</option>
                    <option value="Civit II">Civit II</option>
                    <option value="Log 101">Log 101</option>
                </select>
            </div>

            <div class="input-group">
                <label>Contrata√ß√£o</label>
                <select id="contratacao" required>
                    <option value="">Selecione...</option>
                    <option value="Diarista">Diarista</option>
                    <option value="Funcion√°rio">Funcion√°rio</option>
                </select>
            </div>

            <div class="input-group">
                <label>Setor</label>
                <input id="setor" type="text" placeholder="Ex: Separa√ß√£o" required>
            </div>

            <div class="input-group">
                <label>Carga Hor√°ria</label>
                <select id="carga" required>
                    <option value="">Selecione...</option>
                    <option value="07:00 √†s 17:00">07:00 √†s 17:00</option>
                    <option value="08:00 √†s 18:00">08:00 √†s 18:00</option>
                    <option value="09:00 √†s 19:00">09:00 √†s 19:00</option>
                    <option value="10:00 √†s 20:00">10:00 √†s 20:00</option>
                </select>
            </div>

            <div class="input-group">
                <label>Ativo</label>
                <select id="ativo" required>
                    <option value="">Selecione...</option>
                    <option value="Sim">Sim</option>
                    <option value="N√£o">N√£o</option>
                </select>
            </div>
        </div>

        <button type="submit" class="btn">Salvar Cadastro</button>
    </form>
</div>

<script>

    // ============ M√ÅSCARA CPF ==================
    function mascaraCPF(campo) {
        let v = campo.value.replace(/\D/g, "");

        if (v.length > 3) v = v.replace(/(\d{3})(\d)/, "$1.$2");
        if (v.length > 6) v = v.replace(/(\d{3})(\d)/, "$1.$2");
        if (v.length > 9) v = v.replace(/(\d{3})(\d{2})$/, "$1-$2");

        campo.value = v;
    }

    // ============ VALIDA CPF ==================
    function validarCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;

        let soma = 0;
        for (let i = 0; i < 9; i++) soma += parseInt(cpf[i]) * (10 - i);
        let dig1 = (soma * 10) % 11;
        if (dig1 === 10) dig1 = 0;
        if (dig1 !== parseInt(cpf[9])) return false;

        soma = 0;
        for (let i = 0; i < 10; i++) soma += parseInt(cpf[i]) * (11 - i);
        let dig2 = (soma * 10) % 11;
        if (dig2 === 10) dig2 = 0;

        return dig2 === parseInt(cpf[10]);
    }

    // ============ M√ÅSCARA TELEFONE ===============
    function mascaraTelefone(campo) {
        let v = campo.value.replace(/\D/g, "");

        if (v.length > 2) v = v.replace(/(\d{2})(\d)/, "($1) $2");
        if (v.length > 7) v = v.replace(/(\d{5})(\d)/, "$1-$2");

        campo.value = v;
    }

    // ============ M√ÅSCARA CEP ===============
    function mascaraCEP(campo) {
        let v = campo.value.replace(/\D/g, "");
        if (v.length > 5) v = v.replace(/(\d{5})(\d)/, "$1-$2");
        campo.value = v;
    }

    // ============ BUSCAR CEP ==================
    async function buscarCEP(cep) {
        cep = cep.replace(/\D/g, '');
        if (cep.length !== 8) return;

        try {
            const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const dados = await r.json();

            if (!dados.erro) {
                document.getElementById("endereco").value = dados.logradouro || "";
                document.getElementById("cidade").value = dados.localidade || "";
                document.getElementById("estado").value = dados.uf || "";
            }
        } catch (e) {
            console.log("Erro ao buscar CEP");
        }
    }

    // ============ FOR√áA UF EM MAI√öSCULAS ===============
    document.getElementById("estado").addEventListener("input", (e) => {
        e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g, "").slice(0, 2);
    });

    // ============ ENVIO DO FORMUL√ÅRIO ===============
    const API_URL = "http://localhost:3000";
    const token = localStorage.getItem("token");

    document.getElementById("form-colaborador").addEventListener("submit", async (e) => {
        e.preventDefault();

        const cpf = document.getElementById("cpf").value;

        if (!validarCPF(cpf)) {
            alert("CPF inv√°lido!");
            return;
        }

        const dados = {
            nome: document.getElementById("nome").value.trim(),
            email: document.getElementById("email").value.trim(),
            cpf: cpf.trim(),
            telefone: document.getElementById("telefone").value.trim(),
            cep: document.getElementById("cep").value.trim(),
            endereco: document.getElementById("endereco").value.trim(),
            numero: document.getElementById("numero").value.trim(),
            cidade: document.getElementById("cidade").value.trim(),
            estado: document.getElementById("estado").value.trim(),
            armazem: document.getElementById("armazem").value,
            setor: document.getElementById("setor").value.trim(),
            contratacao: document.getElementById("contratacao").value,
            carga: document.getElementById("carga").value,
            ativo: document.getElementById("ativo").value
        };

        try {
            const resposta = await fetch(`${API_URL}/colaboradores`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": token
                },
                body: JSON.stringify(dados)
            });

            const result = await resposta.json();

            if (!resposta.ok) {
                alert(result.error || "Erro ao cadastrar.");
                return;
            }

            alert("Colaborador cadastrado com sucesso!");

            // üî• REDIRECIONAMENTO FUNCIONANDO
            window.location.href = "../lista/lista.html";

        } catch (err) {
            alert("Erro ao conectar com o servidor.");
            console.error(err);
        }
    });

</script>

</body>
</html>