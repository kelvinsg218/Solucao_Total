<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Colaborador</title>
    <link rel="stylesheet" href="cadastro.css">
</head>
<body>

<div class="container">
    <h1 id="titulo">Cadastrar Colaborador</h1>

    <form id="form-colaborador">

        <div class="input-group">
            <label>Nome do colaborador</label>
            <input type="text" id="nome" required>
        </div>

        <div class="input-group">
            <label>Função</label>
            <input type="text" id="funcao" required>
        </div>

        <div class="input-group">
            <label>Valor da diária</label>
            <input type="number" id="diaria" min="0" step="0.01" required>
        </div>

        <div class="input-group">
            <label>Tipo</label>
            <select id="tipo" required>
                <option value="diarista">Diarista</option>
                <option value="fixo">Fixado</option>
            </select>
        </div>

        <div class="input-group">
            <label>Status</label>
            <select id="status" required>
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
            </select>
        </div>

        <button class="btn" type="submit">Salvar</button>
    </form>

    <p id="msg" style="color:red; margin-top:10px;"></p>

</div>

<script>
    const API_URL = "http://localhost:3000";
    const token = localStorage.getItem("token");

    // ============================
    // VERIFICA LOGIN
    // ============================
    if (!token) {
        window.location.href = "../login/login.html";
    }

    // ============================
    // CAPTURA ID (EDIÇÃO)
    // ============================
    const urlParams = new URLSearchParams(window.location.search);
    const colaboradorId = urlParams.get("id");

    // Se for edição → carrega dados
    if (colaboradorId) {
        document.getElementById("titulo").textContent = "Editar Colaborador";
        carregarColaborador();
    }

    // ============================
    // FUNÇÃO PARA CARREGAR DADOS
    // ============================
    async function carregarColaborador() {
        try {
            const resp = await fetch(`${API_URL}/colaboradores/${colaboradorId}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });

            const dados = await resp.json();

            document.getElementById("nome").value = dados.nome;
            document.getElementById("funcao").value = dados.funcao;
            document.getElementById("diaria").value = dados.diaria;
            document.getElementById("tipo").value = dados.tipo;
            document.getElementById("status").value = dados.status;

        } catch (err) {
            alert("Erro ao carregar colaborador.");
            console.error(err);
        }
    }

    // ============================
    // SALVAR (CRIAR OU EDITAR)
    // ============================
    document.getElementById("form-colaborador").addEventListener("submit", async (e) => {
        e.preventDefault();

        const msg = document.getElementById("msg");
        msg.textContent = "";

        const dados = {
            nome: document.getElementById("nome").value.trim(),
            funcao: document.getElementById("funcao").value.trim(),
            diaria: Number(document.getElementById("diaria").value),
            tipo: document.getElementById("tipo").value,
            status: document.getElementById("status").value
        };

        try {
            let resposta;

            if (colaboradorId) {
                // ==============
                // ATUALIZAR
                // ==============
                resposta = await fetch(`${API_URL}/colaboradores/${colaboradorId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(dados)
                });

            } else {
                // ==============
                // CRIAR
                // ==============
                resposta = await fetch(`${API_URL}/colaboradores`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(dados)
                });
            }

            const resultado = await resposta.json();

            if (!resposta.ok) {
                msg.textContent = resultado.error || "Erro ao salvar.";
                return;
            }

            // Redireciona após salvar
            window.location.href = "../lista/lista.html";

        } catch (err) {
            msg.textContent = "Erro ao conectar ao servidor.";
            console.error(err);
        }
    });

</script>

</body>
</html>
