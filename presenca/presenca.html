<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Presen√ßa</title>
    <link rel="stylesheet" href="presenca.css">

    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container container-box mt-4">

    <h2>Lista de Presen√ßa</h2>
    <a href="../lista/lista.html" class="btn btn-secondary botao-voltar-fixo">
        ‚Üê Voltar
    </a>

    <p>Selecione as datas para gerar a lista</p>

    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalDatas">
        Selecionar Datas
    </button>

    <hr>

    <div id="areaFiltros" class="row mt-3" style="display:none;">

        <div class="col-md-4">
            <label><strong>Filtrar por Armaz√©m</strong></label>
            <select id="filtroArmazem" class="form-control">
                <option value="">Todos</option>
                <option value="Taquara">Taquara</option>
                <option value="Porto Canoa">Porto Canoa</option>
                <option value="Civit II">Civit II</option>
                <option value="Log 101">Log 101</option>
            </select>
        </div>

        <div class="col-md-4">
            <label><strong>Filtrar por Setor</strong></label>
            <input id="filtroSetor" class="form-control" type="text" placeholder="Ex: Separa√ß√£o">
        </div>

        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-dark w-100" onclick="aplicarFiltros()">Aplicar Filtros</button>
        </div>

    </div>

    <div id="areaLista"></div>

    <!-- Bot√£o de salvar (fica vis√≠vel depois que a lista √© gerada) -->
    <button id="btnSalvar" class="btn btn-success mt-3 w-100" style="display:none;" onclick="salvarPresencas()">
        Salvar Presen√ßas
    </button>
</div>

<!-- MODAL DE DATAS -->
<div class="modal fade" id="modalDatas" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Selecionar Per√≠odo</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <label><strong>Data inicial</strong></label>
                <input type="date" id="dataInicio" class="form-control mb-3">

                <label><strong>Data final</strong></label>
                <input type="date" id="dataFim" class="form-control">
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" id="btnGerar" disabled onclick="gerarLista()">
                    Gerar Lista
                </button>
            </div>

        </div>
    </div>
</div>

<!-- BOOTSTRAP -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let colaboradores = [];
    let colaboradoresFiltrados = [];

    // =========================
    // CARREGAR COLABORADORES DO BACKEND
    // =========================
    async function carregarColaboradores() {
        try {
            const req = await fetch("http://localhost:3000/colaboradores");
            colaboradores = await req.json();
            colaboradoresFiltrados = [...colaboradores];
        } catch (err) {
            alert("Erro ao carregar colaboradores!");
            console.error(err);
        }
    }
    carregarColaboradores();


    // =========================
    // VALIDA√á√ÉO DAS DATAS
    // =========================
    function validarDatas() {
        const inicio = document.getElementById("dataInicio");
        const fim = document.getElementById("dataFim");
        const botao = document.getElementById("btnGerar");

        if (inicio.value) fim.min = inicio.value;
        if (fim.value) inicio.max = fim.value;

        botao.disabled = !(inicio.value && fim.value && new Date(inicio.value) <= new Date(fim.value));
    }

    document.getElementById("dataInicio").addEventListener("change", validarDatas);
    document.getElementById("dataFim").addEventListener("change", validarDatas);


    // =========================
    // APLICAR FILTROS
    // =========================
    function aplicarFiltros() {
        const armazem = document.getElementById("filtroArmazem").value;
        const setor = document.getElementById("filtroSetor").value.toLowerCase();

        colaboradoresFiltrados = colaboradores.filter(c => {
            const okArmazem = armazem ? c.armazem === armazem : true;
            const okSetor = setor ? c.setor.toLowerCase().includes(setor) : true;
            return okArmazem && okSetor;
        });

        const inicio = document.getElementById("dataInicio").value;
        const fim = document.getElementById("dataFim").value;

        if (inicio && fim) {
            gerarLista();
        } else {
            alert("Filtros aplicados. Agora selecione as datas.");
        }
    }


    // =========================
    // GERAR LISTA
    // =========================
    function gerarLista() {
        const inicio = document.getElementById("dataInicio").value;
        const fim = document.getElementById("dataFim").value;

        const area = document.getElementById("areaLista");
        const datas = gerarIntervaloDatas(inicio, fim);

        if (!colaboradoresFiltrados.length) {
            area.innerHTML = `<p class="text-danger mt-3">Nenhum colaborador encontrado.</p>`;
            return;
        }

        let html = `
        <div class="titulo-data">
            Lista de Presen√ßa: <strong>${formatarData(inicio)}</strong> at√© <strong>${formatarData(fim)}</strong>
        </div>
    `;

        datas.forEach(data => {
            html += `
            <h4 class="mt-4">üìÖ ${formatarData(data)}</h4>

            <table class="table table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Nome</th>
                        <th>Setor</th>
                        <th>CPF</th>
                        <th>Presen√ßa</th>
                        <th>Coment√°rio</th>
                    </tr>
                </thead>

                <tbody>
                    ${colaboradoresFiltrados.map(c => `
                        <tr>
                            <td>${c.nome}</td>
                            <td>${c.setor}</td>
                            <td>${c.cpf}</td>

                            <td>
                                <input 
                                    type="checkbox"
                                    class="presencaCheck"
                                    data-id="${c.id}"
                                    data-dia="${data}"
                                >
                            </td>

                            <td>
                                <input 
                                    type="text"
                                    class="form-control comentarioInput"
                                    placeholder="Ex: saiu 12h"
                                    data-id="${c.id}"
                                    data-dia="${data}"
                                >
                            </td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>
        `;
        });

        area.innerHTML = html;

        document.getElementById("areaFiltros").style.display = "flex";
        document.getElementById("btnSalvar").style.display = "block";

        const modal = bootstrap.Modal.getInstance(document.getElementById("modalDatas"));
        modal.hide();
    }


    // =========================
    // SALVAR PRESEN√áAS
    // =========================
    async function salvarPresencas() {
        const checks = document.querySelectorAll(".presencaCheck");

        let totalEnviados = 0;

        for (let check of checks) {
            if (check.checked) {
                const id = check.dataset.id;
                const dia = check.dataset.dia;

                const comentarioInput = document.querySelector(`.comentarioInput[data-id="${id}"][data-dia="${dia}"]`);
                const comentario = comentarioInput.value;

                await fetch("http://localhost:3000/dias/adicionar", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        colaborador_id: id,
                        data: dia,
                        comentario: comentario || "",
                        valor: 0
                    })
                });

                totalEnviados++;
            }
        }

        alert(`Presen√ßas salvas com sucesso! (${totalEnviados} registros enviados)`);

        document.getElementById("btnSalvar").disabled = true;
    }


    // =========================
    // GERA LISTA DE DATAS
    // =========================
    function gerarIntervaloDatas(inicio, fim) {
        const atual = new Date(inicio);
        const dataFim = new Date(fim);
        const lista = [];

        while (atual <= dataFim) {
            lista.push(atual.toISOString().split("T")[0]);
            atual.setDate(atual.getDate() + 1);
        }

        return lista;
    }


    // =========================
    // FORMATAR DATA
    // =========================
    function formatarData(data) {
        const p = data.split("-");
        return `${p[2]}/${p[1]}/${p[0]}`;
    }

</script>

</body>
</html>
