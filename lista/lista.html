<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Colaboradores</title>

    <link rel="stylesheet" href="lista.css">
    
</head>
<body>

<div class="container container-box mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Lista de Colaboradores</h2>
        <div class="d-flex gap-2">
            <a href="../pagina-registro/cadastro.html" class="btn btn-primary"> Novo Colaborador</a>
            <a href="../dashboard/dashboard.html" class="btn btn-success">ðŸ“Š Dashboard</a>
            <a href="../presenÃ§a/presenca.html" class="btn btn-success">Lista de PresenÃ§a</a>
            <button class="btn btn-outline-danger" id="btnLogout">Sair</button>
        </div>
    </div>

    <input id="busca" type="text" class="search" placeholder="Buscar por nome, CPF, cidade, setor...">

    <table class="tabela">
        <thead>
        <tr>
            <th>Nome</th>
            <th>CPF</th>
            <th>E-mail</th>
            <th>Telefone</th>
            <th>Cidade</th>
            <th>ContrataÃ§Ã£o</th>
            <th>Setor</th>
            <th>Carga HorÃ¡ria</th>
            <th>Ativo</th>
            <th>AÃ§Ãµes</th>
        </tr>
        </thead>
        <tbody id="lista-colaboradores"></tbody>
    </table>

    <p id="msg" class="msg"></p>
</div>

<script>
    const API_URL = "http://localhost:3000";
    const token = localStorage.getItem("token");

    // redireciona se nÃ£o estiver logado
    if(!token){
        window.location.href = "../login/login.html";
    }

    const lista = document.getElementById("lista-colaboradores");
    const busca = document.getElementById("busca");

    // ============================
    //   CARREGAR LISTA
    // ============================
    async function carregar(){
        try {
            const resp = await fetch(`${API_URL}/colaboradores`, {
                headers: { "Authorization": token }
            });

            const dados = await resp.json();
            montar(dados);
        } catch (e) {
            document.getElementById("msg").textContent = "Erro ao carregar colaboradores.";
        }
    }

    // ============================
    //   MONTAR TABELA
    // ============================
    function montar(dados){
        lista.innerHTML = "";

        dados.forEach(c => {
            const tr = document.createElement("tr");

            tr.innerHTML = `
            <td>${c.nome}</td>
            <td>${c.cpf}</td>
            <td>${c.email}</td>
            <td>${c.telefone}</td>
            <td>${c.cidade}</td>
            <td>${c.contratacao}</td>
            <td>${c.setor}</td>
            <td>${c.carga}</td>
            <td>${c.status}</td>
            <td>
                <button class="btn yellow" onclick="editar(${c.id})">Editar</button>
                <button class="btn red" onclick="excluir(${c.id})">Excluir</button>
                <button class="btn cyan">Status</button>
            </td>
        `;

            lista.appendChild(tr);
        });
    }

    // ============================
    //   EDITAR
    // ============================
    function editar(id){
        window.location.href = `../cadastro/cadastro.html?id=${id}`;
    }

    // ============================
    //   EXCLUIR
    // ============================
    async function excluir(id){
        if(!confirm("Tem certeza que deseja excluir?")) return;

        try {
            const resp = await fetch(`${API_URL}/colaboradores/${id}`, {
                method: "DELETE",
                headers: { "Authorization": token }
            });

            carregar();
        } catch(e){
            alert("Erro ao excluir.");
        }
    }

    // ============================
    //   BUSCA
    // ============================
    busca.addEventListener("input", async () => {
        const termo = busca.value.toLowerCase();

        const resp = await fetch(`${API_URL}/colaboradores`, {
            headers: { "Authorization": token }
        });

        const dados = await resp.json();

        const filtrados = dados.filter(c =>
            c.nome.toLowerCase().includes(termo) ||
            c.cpf.toLowerCase().includes(termo) ||
            c.cidade.toLowerCase().includes(termo) ||
            c.setor.toLowerCase().includes(termo)
        );

        montar(filtrados);
    });

    // ============================
    //   LOGOUT
    // ============================
    function logout(){
        localStorage.clear();
        window.location.href = "../login/login.html";
    }

    carregar();
</script>

</body>
</html>
